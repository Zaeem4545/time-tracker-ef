# Deployment Guide - Environment Configuration

This guide explains how to configure the application for both **local development** and **production/Docker** environments.

## Architecture Overview

- **Frontend**: Angular application served via Nginx
- **Backend**: Node.js/Express API server
- **Database**: MySQL 5.7

## Local Development Setup

### Prerequisites
- Node.js 18+
- MySQL 5.7+ (or use Docker for database only)
- Angular CLI

### Frontend (Local)

```bash
# Install dependencies
npm install

# Run development server
ng serve
# App runs on http://localhost:4200
# API calls go to http://localhost:3000 (default)
```

**Configuration**: Uses `src/environments/environment.ts`
- API Base: `http://localhost:3000`
- Production: `false`

### Backend (Local)

```bash
cd backend

# Install dependencies
npm install

# Create .env file (optional - uses defaults if not present)
cp .env.example .env
# Edit .env with your local database credentials

# Run server
npm start
# or
node server.js
```

**Default Configuration** (if `.env` not present):
- Port: `3000`
- DB Host: `localhost`
- DB User: `root`
- DB Password: `` (empty)
- DB Name: `time_tracking`
- DB Port: `3306`

## Production/Docker Setup

### Quick Start

```bash
# Build and start all services
docker-compose up -d --build

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

### Environment Variables

Create a `.env` file in the project root (optional):

```env
# Frontend
API_BASE=/api
PRODUCTION=true

# Backend
FRONTEND_URL=https://projects.expertflow.com
DB_PASSWORD=your_secure_password
JWT_SECRET=your_secure_jwt_secret

# Database
MYSQL_ROOT_PASSWORD=your_secure_root_password
MYSQL_PASSWORD=your_secure_password
```

### Docker Compose Configuration

The `docker-compose.yml` file supports environment variable substitution:

```yaml
services:
  frontend:
    environment:
      API_BASE: "${API_BASE:-/api}"      # Default: /api
      PRODUCTION: "${PRODUCTION:-true}"   # Default: true
  
  backend:
    environment:
      DB_HOST: "${DB_HOST:-db}"          # Default: db
      DB_USER: "${DB_USER:-tt_user}"     # Default: tt_user
      DB_PASSWORD: "${DB_PASSWORD:-tt_password}"  # Default: tt_password
      FRONTEND_URL: "${FRONTEND_URL:-}"  # Optional FQDN
```

## Configuration Details

### Frontend Configuration

**Local Development:**
- File: `src/environments/environment.ts`
- API Base: `http://localhost:3000`

**Production (Docker):**
- Runtime config: `/assets/config.json` (generated from env vars)
- Generated by: `docker-entrypoint-frontend.sh`
- Environment variables: `API_BASE`, `PRODUCTION`

### Backend Configuration

**Local Development:**
- File: `backend/.env` (optional)
- Config: `backend/config/config.js`
- Uses `dotenv` to load `.env` file

**Production (Docker):**
- Environment variables passed via `docker-compose.yml`
- Config: `backend/config/config.js` reads from `process.env`
- All values have sensible defaults

### Database Configuration

**Local Development:**
- Connect to local MySQL instance
- Default: `localhost:3306`

**Production (Docker):**
- MySQL container: `db`
- Default credentials: `tt_user` / `tt_password`
- Can be overridden via environment variables

## Environment Variables Reference

### Frontend Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `API_BASE` | `/api` | API base URL path |
| `PRODUCTION` | `true` | Production mode flag |

### Backend Variables

| Variable | Default (Docker) | Default (Local) | Description |
|----------|------------------|-----------------|-------------|
| `PORT` | `3000` | `3000` | Server port |
| `NODE_ENV` | `production` | `development` | Node environment |
| `DB_HOST` | `db` | `localhost` | Database hostname |
| `DB_USER` | `tt_user` | `root` | Database username |
| `DB_PASSWORD` | `tt_password` | `` | Database password |
| `DB_NAME` | `time_tracking` | `time_tracking` | Database name |
| `DB_PORT` | `3306` | `3306` | Database port |
| `FRONTEND_URL` | - | - | Frontend URL for CORS |
| `CORS_ORIGINS` | - | - | Comma-separated CORS origins |
| `JWT_SECRET` | `your-secret-key...` | `your-secret-key...` | JWT secret |
| `MAX_FILE_SIZE` | `10mb` | `10mb` | Max upload size |

### Database Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `MYSQL_ROOT_PASSWORD` | `rootpassword` | MySQL root password |
| `MYSQL_DATABASE` | `time_tracking` | Database name |
| `MYSQL_USER` | `tt_user` | Database user |
| `MYSQL_PASSWORD` | `tt_password` | Database password |

## Examples

### Example 1: Local Development

```bash
# Terminal 1 - Backend
cd backend
npm start

# Terminal 2 - Frontend
ng serve
```

### Example 2: Docker with Custom FQDN

```bash
# Set environment variables
export FRONTEND_URL=https://projects.expertflow.com
export DB_PASSWORD=secure_password_123

# Start services
docker-compose up -d --build
```

### Example 3: Docker with .env File

```bash
# Create .env file
cat > .env <<EOF
FRONTEND_URL=https://projects.expertflow.com
DB_PASSWORD=secure_password_123
JWT_SECRET=my-secure-jwt-secret-key
MYSQL_ROOT_PASSWORD=secure_root_password
EOF

# Start services (docker-compose automatically reads .env)
docker-compose up -d --build
```

## Verification

### Check Frontend Config
```bash
docker exec time-tracking-frontend cat /usr/share/nginx/html/assets/config.json
```

### Check Backend Config
```bash
# View backend logs
docker logs time-tracking-backend

# Look for:
# - "Database configuration"
# - "CORS Configuration"
# - "Server running on port"
```

### Test API Connection
```bash
# From host
curl http://localhost:3000/api/test

# From within Docker network
docker exec time-tracking-backend curl http://localhost:3000/api/test
```

## Troubleshooting

### Backend can't connect to database
1. Check database container is running: `docker ps`
2. Verify `DB_HOST` matches database service name (`db`)
3. Check credentials match in both backend and database services
4. View database logs: `docker logs time-tracking-db`

### CORS errors
1. Set `FRONTEND_URL` environment variable
2. Check backend logs for CORS configuration
3. Verify frontend URL matches exactly (including protocol)
4. Check browser console for specific CORS error

### Frontend can't reach backend
1. Verify `API_BASE` is correct (`/api` for production)
2. Check nginx proxy configuration
3. Verify backend is running: `docker logs time-tracking-backend`
4. Test backend directly: `curl http://localhost:3000/api/test`

## Security Notes

1. **Never commit `.env` files** - They contain sensitive credentials
2. **Change default passwords** in production
3. **Use strong JWT secrets** in production
4. **Set `FRONTEND_URL`** to prevent unauthorized CORS access
5. **Use HTTPS** in production (configure SSL certificates)

## Migration from Local to Docker

1. Export local database:
   ```bash
   mysqldump -u root -p time_tracking > backup.sql
   ```

2. Start Docker services:
   ```bash
   docker-compose up -d
   ```

3. Import database:
   ```bash
   docker exec -i time-tracking-db mysql -u tt_user -ptt_password time_tracking < backup.sql
   ```

4. Update environment variables in `docker-compose.yml` or `.env`

5. Restart services:
   ```bash
   docker-compose restart
   ```

